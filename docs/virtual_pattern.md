# Pattern of virtual function generation

When a function that can be overriden through the language bindings is encountered, the following steps are done.

1. In the original language, generate a new class that inherits a class containing virtual functions and generate overrides for them. This is done to make sure that whenever something in the original code base calls a virtual function, the language's polymorphism will kick in and call the generated function. The generated class will be referred to as `extension`.
2. In the original language function pointers for each virtual function should be generated inside `extension`. These point to functions that the given language bindings wish to be invoked upon a virtual call. The functions should return the same type as the virtual functions and take the same parameters. In addition the first two parameters should be the following
    * The first parameter is an abstract pointer (`void*`) pointing to a context that the language bindings might require. This could internally be a `JNIEnv*` for an example.
    * The second parameter is an abstract pointer (`void*`) to an instance of a wrapper class within the language bindings. In the case of C++ this could be `this` of the given class object or `jobject` if the language bindings are made for Java.
3. In the original language pointers to `context` and `object` should be generated for `extension`. These will be passed to the previously mentioned function pointers.
4. In the `glue code` the following externally callable functions are generated:
    * `registerContext_ClassName` which is used to associate the `context` and `object` pointing to the object from language bindings with the object that was created with `ClassName_construct`. The return type should be `void`. The first parameter should be a pointer returned by `ClassName_construct`. The second parameter should be a pointer the necessary context or a null. The third parameter should be a pointer to an object within the `language bindings` (e.g. `this` in C++).
    * `registerFunctions_ClassName` Which is used to associate callback functions to use upon a virtual function call. The first parameter should be a pointer returned by `ClassName_construct`. The rest of the parameters should be pointers to functions to call upon a virtual call. Their order is determined by order of appearance in the simplified hierarchy.
5. In the `language bindings` call `registerContext_ClassName` and `registerFunctions_ClassName` after `ClassName_construct` has been called.
6. In the `glue code`, any bridge function that calls a virtual function should no a non-polymorphic call to the function. This is because when the bridge function for a virtual function is called, the default implementation should be invoked. When the original code base invokes a virtual function, the functions defined in `registerFunctions_className` should intercept the function call and do a polymorphic call within the context of the `language bindings`. If the language bindings wish to invoke the default implementation, they can simply call the bridge function for it.